## [Работа с хранилищами localStorage и sessionStorage](#)


### Строки поиска

"как изменить размер хранилища localstorage",
"исключения в localstorage".

### [LocalStorage, sessionStorage](https://learn.javascript.ru/localstorage)

Объекты веб-хранилища localStorage и sessionStorage позволяют хранить пары ключ/значение в браузере.

Что в них важно – данные, которые в них записаны, сохраняются после обновления страницы (в случае sessionStorage) и даже после перезапуска браузера (при использовании localStorage).

***В отличие от куки***, объекты веб-хранилища не отправляются на сервер при каждом запросе. Именно поэтому мы можем хранить гораздо больше данных. Большинство современных браузеров могут выделить как минимум ***5 мегабайтов данных (или больше)***, и этот размер можно поменять в настройках.

Ещё одно отличие от куки – сервер не может манипулировать объектами хранилища через HTTP-заголовки. Всё делается при помощи JavaScript.
Хранилище привязано к источнику (домен/протокол/порт). Это значит, что разные протоколы или поддомены определяют разные объекты хранилища, и они не могут получить доступ к данным друг друга.

Объекты хранилища localStorage и sessionStorage предоставляют одинаковые методы и свойства:

- setItem(key, value) – сохранить пару ключ/значение.
- getItem(key) – получить данные по ключу key.
- removeItem(key) – удалить данные с ключом key.
- clear() – удалить всё.
- key(index) – получить ключ на заданной позиции.
- length – количество элементов в хранилище.

***Основные особенности localStorage:***

Этот объект один на все вкладки и окна в рамках источника (один и тот же домен/протокол/порт). Данные не имеют срока давности, по которому истекают и удаляются. Сохраняются после перезапуска браузера и даже ОС.

Например, если запустить этот код…

```
localStorage.setItem('test', 1);
```

…И закрыть/открыть браузер или открыть ту же страницу в другом окне, то можно получить данные следующим образом:

```
alert( localStorage.getItem('test') ); // 1
```

Нам достаточно находиться на том же источнике (домен/протокол/порт), при этом URL-путь может быть разным.

Объект localStorage доступен всем окнам из одного источника, поэтому, если мы устанавливаем данные в одном окне, изменения становятся видимыми в другом.

Также можно получать/записывать данные, как в обычный объект:

```
// установить значение для ключа
localStorage.test = 2;

// получить значение по ключу
alert( localStorage.test ); // 2

// удалить ключ
delete localStorage.test;
```

А как получить все значения или ключи? К сожалению, объекты веб-хранилища нельзя перебрать в цикле, они не итерируемы. Но можно пройти по ним, как по обычным массивам:

```
for(let i=0; i<localStorage.length; i++) {
  let key = localStorage.key(i);
  alert(`${key}: ${localStorage.getItem(key)}`);
}
```

#### Только строки

Обратите внимание, что ключ и значение должны быть строками.

Если мы используем любой другой тип, например число или объект, то он автоматически преобразуется в строку:

```
localStorage.user = {name: "John"};
alert(localStorage.user); // [object Object]
```

Мы можем использовать JSON для хранения объектов:

```
localStorage.user = JSON.stringify({name: "John"});
// немного позже
let user = JSON.parse( localStorage.user );
alert( user.name ); // John
```

Также возможно привести к строке весь объект хранилища, например для отладки:

```
// для JSON.stringify добавлены параметры форматирования, чтобы объект выглядел лучше
alert( JSON.stringify(localStorage, null, 2) );
```
#### Событие storage

Когда обновляются данные в localStorage или sessionStorage, генерируется событие ***storage*** со следующими свойствами:

- key – ключ, который обновился (null, если вызван .clear()).
- oldValue – старое значение (null, если ключ добавлен впервые).
- newValue – новое значение (null, если ключ был удалён).
- url – url документа, где произошло обновление.
- storageArea – объект localStorage или sessionStorage, где произошло обновление.
-
Важно: событие срабатывает на всех остальных объектах window, где доступно хранилище, кроме того окна, которое его вызвало.

***Давайте уточним.***

Представьте, что у вас есть два окна с одним и тем же сайтом. Хранилище localStorage разделяется между ними. Вы можете открыть эту страницу в двух окнах браузера, чтобы проверить приведённый ниже код.

Теперь, если оба окна слушают window.onstorage, то каждое из них будет реагировать на обновления, произошедшие в другом окне.

```
// срабатывает при обновлениях, сделанных в том же хранилище из других документов
window.onstorage = event => { // можно также использовать window.addEventListener('storage', event => {
  if (event.key != 'now') return;
  alert(event.key + ':' + event.newValue + " at " + event.url);
};

localStorage.setItem('now', Date.now());
```

Обратите внимание, что событие также содержит ***event.url*** – url-адрес документа, в котором данные обновились.

Также event.storageArea содержит объект хранилища – событие одно и то же для sessionStorage и localStorage, поэтому event.storageArea ссылается на то хранилище, которое было изменено. Мы можем захотеть что-то записать в ответ на изменения.

Это позволяет разным окнам одного источника обмениваться сообщениями.

Современные браузеры также поддерживают Broadcast channel API специальный API для связи между окнами одного источника, он более полнофункциональный, но менее поддерживаемый. Существуют библиотеки (полифилы), которые эмулируют это API на основе localStorage и делают его доступным везде.

### [Проверка доступности localStorage и sessionStorage в браузере](https://developer.donnoval.ru/storage-available/)

Проверка доступности localStorage и sessionStorage в браузере пользователя может быть полезна, если вы хотите убедиться, что браузер пользователя поддерживает эти функции или если вы хотите обработать ситуацию, когда эти функции отключены или недоступны.

```
# Функция пытается записать, а затем удалить элемент из хранилища. 
# Если этот процесс происходит без ошибок, то можно сделать вывод, что хранилище доступно для использования. 
# Если возникает исключение DOMException, это указывает на то, что хранилище недоступно.
function storageAvailable( type )
{
    var storage;
    try 
    {
        storage = window[type];
        var x = '__storage_test__';
        storage.setItem( x, x );
        storage.removeItem( x );
        return true;
    }
    catch(e)
    {
        return e instanceof DOMException && (

            // Проверяем код для ошибки QuotaExceededError 
            // все, кроме Firefox
            e.code === 22 ||
            // Firefox
            e.code === 1014 ||

            // Если код ошибки не доступен, то проверяем имя исключения
            // QuotaExceededError - это имя ошибки в большинстве браузеров, когда превышен лимит хранилища, 
            // а 'NS_ERROR_DOM_QUOTA_REACHED' - это то же самое для Firefox         
            // все, кроме Firefox
            e.name === 'QuotaExceededError' ||
            // Firefox
            e.name === 'NS_ERROR_DOM_QUOTA_REACHED') 

            &&

            // Проверяем, есть ли что-то уже сохранено в хранилище. 
            // Если это истинно, ошибка QuotaExceededError признается валидной. 
            // Ошибки QuotaExceededError не имеют смысла, если хранилище пустое, 
            // поскольку это указывает на то, что проблема, скорее всего, не в ограничении размера хранилища.
            (storage && storage.length !== 0);
    }
}

if( storageAvailable( 'localStorage' ) )
{
    // Можно использовать localStorage
}
else 
{
    // localStorage недоступно
}

if( storageAvailable( 'sessionStorage' ) )
{
    // Можно использовать sessionStorage
}
else 
{
    // sessionStorage недоступно
}
```

***QuotaExceededError: DOM Exception 22*** - это ошибка, которую браузеры (кроме Firefox) выбрасывают, когда вы пытаетесь сохранить больше данных в Web Storage (localStorage или sessionStorage), чем разрешено. Браузеры обычно имеют определенный лимит на количество данных, которые вы можете сохранить в Web Storage. Этот лимит может варьироваться в зависимости от браузера и настроек пользователя, но обычно он составляет несколько мегабайт. Если вы попытаетесь сохранить данные, превышающие этот лимит, вы получите ошибку QuotaExceededError. Это помогает предотвратить злоупотребление этой функцией за счет сохранения чрезмерно больших объемов данных. Исключение DOM 22 - это просто другое имя для этой ошибки. Некоторые браузеры используют коды ошибок для идентификации различных типов исключений DOM, и 22 - это код для QuotaExceededError.

***Код исключения 1014*** относится к ошибке QuotaExceededError в браузере Firefox. Когда лимит хранилища превышен (например, при использовании localStorage или sessionStorage), браузер выбрасывает исключение QuotaExceededError. В большинстве браузеров это исключение имеет код 22, но Firefox использует код 1014 для этой же ошибки. Это означает, что если вы видите исключение с кодом 1014 в Firefox, это означает, что вы пытались сохранить в localStorage или sessionStorage больше данных, чем разрешено. Обычно это ограничение составляет несколько мегабайт, но оно может варьироваться в зависимости от настроек браузера и операционной системы.

### [Клиент: Проверки превышения размера хранилища localStorage и sessionStorage](https://developer.donnoval.ru/quotaexceedederror-localstorage/)

Для проверки превышения размера хранилища, вы можете попытаться добавить данные в хранилище, и, если операция вызывает исключение QuotaExceededError, это означает, что размер хранилища был превышен.

Вот пример функции на JavaScript, которая проверяет, не превышен ли размер хранилища:

```
function isStorageQuotaExceeded( storage )
{
    var isQuotaExceeded = false;

    try 
    {
        // Попытаться добавить временный элемент в хранилище
        var item = 'test';
        storage.setItem( item, item );

        // Если операция прошла успешно, удалить временный элемент
        storage.removeItem(item);

    } 
    catch (e) 
    {
        // Если возникло исключение, проверить, является ли оно ошибкой QuotaExceededError
        isQuotaExceeded = e instanceof DOMException 

        && 

        (
            // все браузеры, кроме Firefox
            e.code === 22 || 

            // Firefox
            e.code === 1014 || 

            // все браузеры, кроме Firefox
            e.name === 'QuotaExceededError' || 

            // Firefox
            e.name === 'NS_ERROR_DOM_QUOTA_REACHED'); 
    }

    return isQuotaExceeded;
}

if( isStorageQuotaExceeded( localStorage ) )
{
    console.log( 'Размер localStorage превышен' );
}

if( isStorageQuotaExceeded( sessionStorage ) )
{
    console.log( 'Размер sessionStorage превышен' );
}
```

Лимиты для localStorage и sessionStorage могут варьироваться в зависимости от браузера, его версии и настроек пользователя. Однако общепринятое значение для большинства современных браузеров составляет 5-10 МБ на домен для localStorage и sessionStorage. Лимит применяются к каждому домену. Это означает, что если у вас есть два разных сайта, каждый из них сможет сохранять до установленного лимита данных в localStorage или sessionStorage. Пользователи могут изменить эти лимиты в настройках своего браузера или полностью отключить Web Storage. Некоторые режимы приватного просмотра также могут временно отключить или ограничить использование Web Storage.


### Библиография

#### [Клиент: Хранение информации в SessionStorage](https://developer.donnoval.ru/sessionstorage/)

#### [Клиент: Хранение информации в LocalStorage](https://developer.donnoval.ru/localstorage/)

###### [к содержанию](#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D1%84%D0%B0%D0%B9%D0%BB%D0%B0-php.ini-%D0%B8-o%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B5%D0%B3%D0%BE-%D0%B4%D0%B8%D1%80%D0%B5%D0%BA%D1%82%D0%B8%D0%B2)
